---
title: "Exploration"
author: "Sean Kent"
date: "3/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
  )

library(tidyverse)
library(schrute)
library(janitor)
library(skimr)
library(fishualize)
library(extrafont)
library(lubridate)
loadfonts(device = "win")
```


## Pull in data

```{r}
office_ratings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-17/office_ratings.csv')

office_ratings
```


```{r}
skimr::skim(theoffice)
```




#### Problem: datasets don't match up

- In `theoffice`, multi-part episodes (ones that aired on the same day but had the same title) are combined, but the episode number is incremented two.  
- In `office_ratings`, most of the multi-part episodes are combined, but the episode number is incremented by only 1.  This is true except in the case of season 6, which strangely splits multi-part episodes in two and thus has separate imdb ratings for each.  
- Thus, a typical join on episode number and season 


**Solution**: 

1. Take the `office_ratings` dataset and combine season 6 episodes manually 
2. create a temporary copy of `theoffice` that is summarized by season, episode, and episode name
3. make sure the two datasets line up on a row basis (even though episode numbering will be off)
4. do a manual join with `cbind`, then `left_join` the information to `theoffice` by the season-episode key


```{r}
# Niagara: Part 1 and Niagara: Part 2 are episodes 4 and 5, need to combine
niagara <- 
  office_ratings %>% 
  filter(season == 6 & episode %in% c(4,5)) %>% 
  summarize(
    season = unique(season),
    episode = min(episode),
    title = "Niagara: Parts 1 and 2",
    imdb_rating = mean(imdb_rating),
    total_votes = mean(total_votes),
    air_date = unique(air_date)
  )

# The Delivery: Part 1 and The Delivery: Part 2 are episodes 17 and 18, need to combine
thedelivery <- 
  office_ratings %>% 
  filter(season == 6 & episode %in% c(17,18)) %>% 
  summarize(
    season = unique(season),
    episode = min(episode),
    title = "The Delivery: Parts 1 and 2",
    imdb_rating = mean(imdb_rating),
    total_votes = mean(total_votes),
    air_date = unique(air_date)
  )

office_ratings2 <- 
  office_ratings %>% 
  filter(!(season == 6 & episode %in% c(4,5,17,18))) %>% 
  rbind(niagara, 
        thedelivery) %>% 
  arrange(season, episode)


```



```{r}
theoffice_episode_level <-
  theoffice %>% 
  select(season, episode, episode_name) %>% 
  unique()

theoffice_episode_level_imdb <- 
  cbind(theoffice_episode_level,
        office_ratings2 %>% select(-season, -episode, -title))

```

```{r}
theoffice_correct <-
  theoffice %>% 
  select(-imdb_rating, -total_votes, -air_date) %>% 
  left_join(
    theoffice_episode_level_imdb,
    by = c("season", "episode")
  )
```



other data issue: season 6 episode 24 should be "The Cover-Up", not "The cover"

## Visualizations

```{r}
season_begin_end_dates <- theoffice_correct %>% 
  mutate(air_date = lubridate::as_date(air_date)) %>% 
  group_by(season) %>% 
  summarize(start_date = min(air_date),
            end_date = max(air_date),
            air_date = mean(air_date),
            imdb_rating = 5)


# theoffice_correct %>% 
#   group_by(season, episode) %>% 
#   summarize(air_date = unique(air_date),
#             imdb_rating = unique(imdb_rating)
#             ) %>% 
#   mutate(air_date = lubridate::as_date(air_date)) %>% 
#   ggplot(aes(air_date, imdb_rating, color = season)) +
#   geom_rect(
#     aes(xmin = start_date, xmax = end_date, 
#         ymin = -Inf, ymax = Inf, 
#         fill = season),
#     alpha = 0.1, 
#     color = rgb(0,0,0,0),
#     data = season_begin_end_dates
#   ) +
#   geom_point() +
#   # scale_fill_brewer(palette = "Set1", aesthetics = c("color", "fill")) +
#   scale_fill_fish_d(option = "Hypsypops_rubicundus") +
#   scale_color_fish_d(option = "Hypsypops_rubicundus") +
#   theme_minimal()


dm_grey <- rgb(182, 180, 181, maxColorValue = 255)

theoffice_correct %>% 
  group_by(season, episode) %>% 
  summarize(air_date = unique(air_date),
            imdb_rating = unique(imdb_rating),
            michael = "Michael" %in% character,
            director = unique(director)
            ) %>% 
  mutate(air_date = lubridate::as_date(air_date)) %>% 
  ggplot(aes(air_date, imdb_rating)) +
  # geom_rect(
  #   aes(xmin = start_date, xmax = end_date, 
  #       ymin = -Inf, ymax = Inf),
  #   alpha = 0.7, 
  #   fill = dm_grey, 
  #   color = rgb(0,0,0,0),
  #   data = season_begin_end_dates
  # ) +
  geom_point(aes(color = michael)) +
  geom_text(
    aes(label = as.numeric(season), y = 5.5),
    fontface = "bold", 
    size = 5,
    color = "white",
    family = "Impact",
    data = season_begin_end_dates
  ) + 
  geom_text(x = lubridate::make_date(year = 2005), y = 5.5, label = "Season",
            color = "white", family = "Impact", hjust = 1) +
  # geom_smooth(aes(group = season), method = "lm", formula = y ~ 1, se = FALSE, color = dm_grey) +
  # scale_fill_brewer(palette = "Set1", aesthetics = c("color", "fill")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y", limits = c(ymd("2004-09-01"), NA)) +
  scale_y_continuous(limits = c(5,10)) +
  scale_color_manual(values = c(rgb(30, 89, 183, maxColorValue = 255), "white")) +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = "black"),
    panel.background = element_rect(fill = "black"),
    panel.grid.major.y = element_line(color = "white", linetype = "dashed"),
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid = element_line(color = "grey10"),
    axis.text = element_text(colour = "white"),
    axis.title = element_text(colour = "white", family = "Impact")
  ) +
  labs(x = NULL,
       y = "IMDB Rating")

```



```{r}
theoffice_correct %>% 
  group_by(season, episode) %>% 
  summarize("Michael" %in% character)
```

```{r}
theoffice_correct %>% 
  group_by(season, episode) %>% 
  summarize(air_date = unique(air_date),
            imdb_rating = unique(imdb_rating),
            michael = "Michael" %in% character,
            director = unique(director),
            writer = unique(writer)
            ) %>% 
  mutate(writer = as.factor(writer)) %>% 
  mutate(writer_top = fct_collapse(writer,
                                   "Mindy Kaling" = "Mindy Kaling",
                                   "B.J. Novak" = "B.J. Novak",
                                   "Paul Lieberstein" = "Paul Lieberstein",
                                   group_other = TRUE),
  )



mutate(writer_cond = case_when(
    "Mindy Kaling" %in% writer ~ "Min"
  ))
  tabyl(writer) %>% 
  arrange(desc(n)) %>% 
  adorn_totals()
  
```


```{r}
theoffice_correct %>% 
  group_by(season, episode) %>% 
  summarize(air_date = unique(air_date),
            imdb_rating = unique(imdb_rating),
            michael = "Michael" %in% character,
            director = unique(director)
            ) %>% 
  filter(director %in% c("Greg Daniels", "Ken Kwapis", "Paul Feig", "Randall Einhorn")) %>% 
  ggplot(aes(director, imdb_rating)) +
  ggbeeswarm::geom_beeswarm()
  
```






## Appendix

### Diagnosing the air_date problem

```{r}
theoffice %>% 
  filter(is.na(air_date)) %>%
  # left_join(office_ratings, by = c("season", "episode")) %>% 
  select(season, episode, episode_name) %>%
  unique()
```


```{r}
theoffice %>% 
  # filter(is.na(air_date)) %>% 
  # left_join(office_ratings, by = c("season", "episode")) %>% 
  select(season, episode, episode_name, air_date) %>%
  unique()
```

```{r}
office_ratings %>% 
  select(season, episode, title, air_date) %>% 
  unique()
```

```{r}
tabyl(office_ratings, season)
tabyl(theoffice %>% select(season, episode) %>% unique(), season)
```


```{r}
office_ratings %>% filter(season == 6)
```

```{r}
theoffice %>% select(season, episode, episode_name) %>% filter(season == "06") %>% unique()
```









